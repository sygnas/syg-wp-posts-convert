{"version":3,"file":"syg-wp-posts-convert.min.js","sources":["../src/helpers/convert_date.js","../src/helpers/remove_tag.js","../src/index.js"],"sourcesContent":["\n// 日付書式変換\nexport default function convert_date (post, key, format) {\n\n    const date = post[key].split(/[: -]/);\n    const YY = date[0];\n    const MM = date[1];\n    const DD = date[2];\n    const hh = date[3];\n    const mm = date[4];\n\n    let output = format;\n    output = output.split('YY').join(YY);\n    output = output.split('MM').join(MM);\n    output = output.split('DD').join(DD);\n    output = output.split('hh').join(hh);\n    output = output.split('mm').join(mm);\n\n    return output;\n}\n","\n// タグ除去\nexport default function remove_tag(post, key) {\n\n    return post[key].replace(/<(\"[^\"]*\"|'[^']*'|[^'\">])*>/g,'');\n\n}\n","/**\r\n * Wordpress get_posts() json to html convert.\r\n * Wordpress の get_posts() の json を html に変換する。\r\n * htmlテンプレートには Handlebarsを使用\r\n *\r\n * @author   Hiroshi Fukuda <info.sygnas@gmail.com>\r\n * @license  MIT\r\n */\r\n\r\n/* eslint no-console: off */\r\n/* eslint no-unused-vars: off */\r\n\r\nimport axios from 'axios';\r\nimport Parser from 'csv-string/lib/parser';\r\n\r\n// ヘルパー\r\nimport convert_date from './helpers/convert_date';\r\nimport remove_tag from './helpers/remove_tag';\r\n\r\n\r\n// ヘルパー関数を使った置き換えのパターン\r\nconst helper_reg = new RegExp('{{{(.+?)\\\\((.*?)\\\\)}}}');\r\n\r\n\r\n/**\r\n *\r\n */\r\n\r\nexport default class {\r\n\r\n    /**\r\n     * コンストラクタ\r\n     * @param {Object} config 設定。const defaults 参照\r\n     */\r\n    constructor (config) {\r\n        // 初期設定\r\n        const defaults = {\r\n            // 表示テンプレート\r\n            template: '<li><a href=\"{{permalink}}\">{{post_title}}</a></li>',\r\n            // 出力先のDOMセレクター\r\n            target: '.js-wp-posts',\r\n            // ヘルパー関数\r\n            helpers: {\r\n                remove_tag,\r\n                convert_date\r\n            }\r\n        };\r\n\r\n        // 設定をマージ\r\n        this.opt = Object.assign(defaults, config);\r\n    }\r\n\r\n    /**\r\n     * json を読み込んでテンプレートを展開する\r\n     * @param {String} url json取得URL\r\n     * @return {Promise} 成功・失敗を返す。成功時には変換したリストを一緒に返す\r\n     */\r\n    start(url) {\r\n        return new Promise((resolve, reject) => {\r\n            // jsonを読み込む\r\n            axios.get(url)\r\n            .then( (res) => {\r\n                // 受け取った記事一覧を変換し、\r\n                // 指定されたエレメントに埋め込む\r\n                const list = this.$_convert_list(res.data);\r\n                this.$_insert_to_target(list.join(''));\r\n\r\n                // Promiseで変換済みリストを返す\r\n                resolve(list);\r\n            })\r\n            .catch((e) => {\r\n                reject(e);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * ヘルパー関数を追加\r\n     * @param {String} name 関数名\r\n     * @param {Function} func 関数\r\n     */\r\n    add_helper(name, func) {\r\n        this.opt.helpers[name] = func;\r\n    }\r\n\r\n\r\n    /**\r\n     * private\r\n     */\r\n\r\n    /**\r\n     * 変換したテンプレートをターゲットエレメントに挿入する\r\n     * エレメントが存在しなければ何もしない\r\n     * @param {String} output 変換済みテンプレート\r\n     */\r\n    $_insert_to_target(output) {\r\n        const target = document.querySelector(this.opt.target);\r\n        if(target) {\r\n            target.insertAdjacentHTML('afterbegin', output);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 受け取った記事リストを変換して返す\r\n     * @param {Array} data WP_postの配列\r\n     * @return {Array} 変換した記事毎の配列\r\n     */\r\n    $_convert_list(data) {\r\n        const output_list = [];\r\n        // console.log(data);\r\n\r\n        data.forEach((post) => {\r\n            const result = this.$_convert_post(post);\r\n            output_list.push(result);\r\n        });\r\n        return output_list;\r\n    }\r\n\r\n    /**\r\n     * 受け取った記事をテンプレートで変換して返す\r\n     * @param {Object} post\r\n     * @return {String} 変換したテンプレート\r\n     */\r\n    $_convert_post(post) {\r\n        let template = this.opt.template;\r\n\r\n        // ヘルパーでの置き換えを処理\r\n        template = this.$_convert_helper(template, post);\r\n        // 記事の項目で検索して書き換え\r\n        template = this.$_convert_simple(template, post);\r\n\r\n        return template;\r\n    }\r\n\r\n    /**\r\n     * 記事データの項目名で置換\r\n     * @param {String} template テンプレート\r\n     * @param {Object} post ポストデータ\r\n     * @return {String} 変換後テンプレート\r\n     */\r\n    $_convert_simple(template, post) {\r\n        Object.keys(post).forEach((key) => {\r\n            template = template.replace(`{{${key}}}`, post[key]);\r\n        });\r\n        return template;\r\n    }\r\n\r\n    /**\r\n     * ヘルパー指定されたパターンからヘルパー名とパラメーターを抜き出して実行する\r\n     * @param {String} template テンプレート\r\n     * @param {Object} post ポストデータ\r\n     * @return {String} 変換後テンプレート\r\n     */\r\n    $_convert_helper(template, post) {\r\n        const helpers = this.opt.helpers;\r\n        let match;\r\n\r\n        while((match = helper_reg.exec(template)) !== null) {\r\n            // 検索パターン\r\n            const pattern = match[0];\r\n            // ヘルパー関数名\r\n            const helper = match[1];\r\n            const parser = new Parser(match[2]);\r\n            // ヘルパーに渡す引数\r\n            const params = parser.File()[0];\r\n            // ヘルパーの実行結果で置換する\r\n            const helper_res = helpers[helper](post, ...params);\r\n            template = template.replace(pattern, helper_res);\r\n        }\r\n        return template;\r\n    }\r\n}\r\n"],"names":["convert_date","post","key","format","date","split","YY","MM","DD","hh","mm","output","join","remove_tag","replace","helper_reg","RegExp","config","defaults","opt","Object","assign","url","Promise","resolve","reject","get","then","res","list","_this","$_convert_list","data","$_insert_to_target","catch","e","name","func","helpers","target","document","querySelector","this","insertAdjacentHTML","output_list","forEach","result","_this2","$_convert_post","push","template","$_convert_helper","$_convert_simple","keys","match","exec","pattern","helper","params","Parser","File","helper_res"],"mappings":"ySAEA,SAAwBA,EAAcC,EAAMC,EAAKC,OAEvCC,EAAOH,EAAKC,GAAKG,MAAM,SACvBC,EAAKF,EAAK,GACVG,EAAKH,EAAK,GACVI,EAAKJ,EAAK,GACVK,EAAKL,EAAK,GACVM,EAAKN,EAAK,GAEZO,EAASR,WACJQ,EAAON,MAAM,MAAMO,KAAKN,KACxBK,EAAON,MAAM,MAAMO,KAAKL,KACxBI,EAAON,MAAM,MAAMO,KAAKJ,KACxBG,EAAON,MAAM,MAAMO,KAAKH,KACxBE,EAAON,MAAM,MAAMO,KAAKF,GCdrC,SAAwBG,EAAWZ,EAAMC,UAE9BD,EAAKC,GAAKY,QAAQ,+BAA+B,+cCiBtDC,EAAa,IAAIC,OAAO,uDAabC,6GAEHC,YAEQ,6DAEF,2DASPC,IAAMC,OAAOC,OAAOH,EAAUD,2CAQjCK,qBACK,IAAIC,QAAQ,SAACC,EAASC,KAEnBC,IAAIJ,GACTK,KAAM,SAACC,OAGEC,EAAOC,EAAKC,eAAeH,EAAII,QAChCC,mBAAmBJ,EAAKjB,KAAK,OAG1BiB,KAEXK,MAAM,SAACC,KACGA,0CAURC,EAAMC,QACRlB,IAAImB,QAAQF,GAAQC,6CAaV1B,OACT4B,EAASC,SAASC,cAAcC,KAAKvB,IAAIoB,QAC5CA,KACQI,mBAAmB,aAAchC,0CASjCqB,cACLY,cAGDC,QAAQ,SAAC5C,OACJ6C,EAASC,EAAKC,eAAe/C,KACvBgD,KAAKH,KAEdF,yCAQI3C,OACPiD,EAAWR,KAAKvB,IAAI+B,kBAGbR,KAAKS,iBAAiBD,EAAUjD,KAEhCyC,KAAKU,iBAAiBF,EAAUjD,4CAW9BiD,EAAUjD,iBAChBoD,KAAKpD,GAAM4C,QAAQ,SAAC3C,KACZgD,EAASpC,aAAaZ,OAASD,EAAKC,MAE5CgD,2CASMA,EAAUjD,WACjBqC,EAAUI,KAAKvB,IAAImB,QACrBgB,SAE0C,QAAvCA,EAAQvC,EAAWwC,KAAKL,KAAqB,KAE1CM,EAAUF,EAAM,GAEhBG,EAASH,EAAM,GAGfI,EAFS,IAAIC,EAAOL,EAAM,IAEVM,OAAO,GAEvBC,EAAavB,EAAQmB,YAAQxD,YAASyD,OACjCR,EAASpC,QAAQ0C,EAASK,UAElCX"}