{"version":3,"file":"wp-posts-convert.es.js","sources":["../src/helpers/convert_date.js","../src/helpers/remove_tag.js","../src/index.js"],"sourcesContent":["\n// 日付書式変換\nexport default function convert_date (post, key, format) {\n\n    const date = post[key].split(/[: -]/);\n    const YY = date[0];\n    const MM = date[1];\n    const DD = date[2];\n    const hh = date[3];\n    const mm = date[4];\n\n    let output = format;\n    output = output.split('YY').join(YY);\n    output = output.split('MM').join(MM);\n    output = output.split('DD').join(DD);\n    output = output.split('hh').join(hh);\n    output = output.split('mm').join(mm);\n\n    return output;\n}\n","\n// タグ除去\nexport default function remove_tag(post, key) {\n\n    return post[key].replace(/<(\"[^\"]*\"|'[^']*'|[^'\">])*>/g,'');\n\n}\n","/**\r\n * Wordpress get_posts() json to html convert.\r\n * Wordpress の get_posts() の json を html に変換する。\r\n * htmlテンプレートには Handlebarsを使用\r\n *\r\n * @author   Hiroshi Fukuda <info.sygnas@gmail.com>\r\n * @license  MIT\r\n */\r\n\r\n/* eslint no-console: off */\r\n/* eslint no-unused-vars: off */\r\n\r\nimport axios from 'axios';\r\nimport Parser from 'csv-string/lib/parser';\r\n\r\n// ヘルパー\r\nimport convert_date from './helpers/convert_date';\r\nimport remove_tag from './helpers/remove_tag';\r\n\r\n\r\n// ヘルパー関数を使った置き換えのパターン\r\nconst helper_reg = new RegExp('{{{(.+?)\\\\((.*?)\\\\)}}}');\r\n\r\n\r\n/**\r\n *\r\n */\r\n\r\nexport default class {\r\n\r\n    /**\r\n     * コンストラクタ\r\n     * @param {Object} config 設定。const defaults 参照\r\n     */\r\n    constructor (config) {\r\n        // 初期設定\r\n        const defaults = {\r\n            // 表示テンプレート\r\n            template: '<li><a href=\"{{permalink}}\">{{post_title}}</a></li>',\r\n            // 出力先のDOMセレクター\r\n            target: '.js-wp-posts',\r\n            // ヘルパー関数\r\n            helpers: {\r\n                remove_tag,\r\n                convert_date\r\n            }\r\n        };\r\n\r\n        // 設定をマージ\r\n        this.opt = Object.assign(defaults, config);\r\n    }\r\n\r\n    /**\r\n     * json を読み込んでテンプレートを展開する\r\n     * @param {String} url json取得URL\r\n     * @return {Promise} 成功・失敗を返す。成功時には変換したリストを一緒に返す\r\n     */\r\n    start(url) {\r\n        return new Promise((resolve, reject) => {\r\n            // jsonを読み込む\r\n            axios.get(url)\r\n            .then( (res) => {\r\n                // 受け取った記事一覧を変換し、\r\n                // 指定されたエレメントに埋め込む\r\n                const list = this.$_convert_list(res.data);\r\n                this.$_insert_to_target(list.join(''));\r\n\r\n                // Promiseで変換済みリストを返す\r\n                resolve(list);\r\n            })\r\n            .catch((e) => {\r\n                reject(e);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * ヘルパー関数を追加\r\n     * @param {String} name 関数名\r\n     * @param {Function} func 関数\r\n     */\r\n    add_helper(name, func) {\r\n        this.opt.helpers[name] = func;\r\n    }\r\n\r\n\r\n    /**\r\n     * private\r\n     */\r\n\r\n    /**\r\n     * 変換したテンプレートをターゲットエレメントに挿入する\r\n     * エレメントが存在しなければ何もしない\r\n     * @param {String} output 変換済みテンプレート\r\n     */\r\n    $_insert_to_target(output) {\r\n        const target = document.querySelector(this.opt.target);\r\n        if(target) {\r\n            target.insertAdjacentHTML('afterbegin', output);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 受け取った記事リストを変換して返す\r\n     * @param {Array} data WP_postの配列\r\n     * @return {Array} 変換した記事毎の配列\r\n     */\r\n    $_convert_list(data) {\r\n        const output_list = [];\r\n        // console.log(data);\r\n\r\n        data.forEach((post) => {\r\n            const result = this.$_convert_post(post);\r\n            output_list.push(result);\r\n        });\r\n        return output_list;\r\n    }\r\n\r\n    /**\r\n     * 受け取った記事をテンプレートで変換して返す\r\n     * @param {Object} post\r\n     * @return {String} 変換したテンプレート\r\n     */\r\n    $_convert_post(post) {\r\n        let template = this.opt.template;\r\n\r\n        // ヘルパーでの置き換えを処理\r\n        template = this.$_convert_helper(template, post);\r\n        // 記事の項目で検索して書き換え\r\n        template = this.$_convert_simple(template, post);\r\n\r\n        return template;\r\n    }\r\n\r\n    /**\r\n     * 記事データの項目名で置換\r\n     * @param {String} template テンプレート\r\n     * @param {Object} post ポストデータ\r\n     * @return {String} 変換後テンプレート\r\n     */\r\n    $_convert_simple(template, post) {\r\n        Object.keys(post).forEach((key) => {\r\n            template = template.replace(`{{${key}}}`, post[key]);\r\n        });\r\n        return template;\r\n    }\r\n\r\n    /**\r\n     * ヘルパー指定されたパターンからヘルパー名とパラメーターを抜き出して実行する\r\n     * @param {String} template テンプレート\r\n     * @param {Object} post ポストデータ\r\n     * @return {String} 変換後テンプレート\r\n     */\r\n    $_convert_helper(template, post) {\r\n        const helpers = this.opt.helpers;\r\n        let match;\r\n\r\n        while((match = helper_reg.exec(template)) !== null) {\r\n            // 検索パターン\r\n            const pattern = match[0];\r\n            // ヘルパー関数名\r\n            const helper = match[1];\r\n            const parser = new Parser(match[2]);\r\n            // ヘルパーに渡す引数\r\n            const params = parser.File()[0];\r\n            // ヘルパーの実行結果で置換する\r\n            const helper_res = helpers[helper](post, ...params);\r\n            template = template.replace(pattern, helper_res);\r\n        }\r\n        return template;\r\n    }\r\n}\r\n"],"names":["convert_date","post","key","format","date","split","YY","MM","DD","hh","mm","output","join","remove_tag","replace","helper_reg","RegExp","config","defaults","opt","Object","assign","url","Promise","resolve","reject","get","then","res","list","$_convert_list","data","$_insert_to_target","catch","e","name","func","helpers","target","document","querySelector","insertAdjacentHTML","output_list","forEach","result","$_convert_post","push","template","$_convert_helper","$_convert_simple","keys","match","exec","pattern","helper","parser","Parser","params","File","helper_res"],"mappings":"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"}